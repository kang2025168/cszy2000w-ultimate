version: "3.9"

services:
  mysql:
    image: mysql:8.0
    container_name: cszy_mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASS}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      TZ: America/Los_Angeles
    ports:
      - "3307:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-p${MYSQL_ROOT_PASSWORD:-rootpass}"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - cszy_net

  tradebot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cszy_tradebot
    working_dir: /app
    env_file:
      - .env
    environment:
      # ✅ 强制保证：tradebot 永远连容器内 mysql（服务名）
      DB_HOST: mysql
      DB_PORT: "3306"
      TZ: America/Los_Angeles
    volumes:
      - ./app:/app/app
      - ./data:/app/data
      - ./logs:/app/logs
      - ./scripts:/app/scripts
    depends_on:
      mysql:
        condition: service_healthy
    command: ["bash", "-lc", "./scripts/run.sh strategy_a"]
    restart: unless-stopped
    networks:
      - cszy_net

networks:
  cszy_net:
    driver: bridge